{
   "AWSTemplateFormatVersion": "2010-09-09",
   "Description": "",
   "Resources": {
      "EC2Instance": {
         "Type": "AWS::EC2::Instance",
         "Properties": {
            "ImageId": "ami-0800fc0fa715fdcfe",
            "InstanceType": "t3.nano",
            "KeyName": "ftp-key-pair",
            "AvailabilityZone":  { "Fn::Select" : [ "2", { "Fn::GetAZs" : { "Ref" : "AWS::Region" } } ] },
            "SubnetId": "subnet-1c54be47",
            "SecurityGroupIds": [ { "Ref" : "EC2SecurityGroup" }],
            "UserData": {"Fn::Base64":{"Fn::Join":["", [
                "#!/bin/bash\n",
                "sudo yum update -y\n",
                "sudo yum install python3 pip -y\n",
                "sudo pip install --upgrade pip\n", 
                "sudo pip install pyftpdlib\n",
                "cd /home/ec2-user\n",
                "sudo touch ftp.log\n",
                "sudo wget https://ftp-ec2-s3-cf.s3.us-west-2.amazonaws.com/requirements.txt\n",
                "sudo pip install -r requirements.txt\n",
                "sudo wget https://ftp-ec2-s3-cf.s3.us-west-2.amazonaws.com/ftp.py\n",
                "sudo wget https://ftp-ec2-s3-cf.s3.us-west-2.amazonaws.com/ftp.sh\n",
                "sudo wget https://ftp-ec2-s3-cf.s3.us-west-2.amazonaws.com/ftp-service\n",
                "sudo mv /home/ec2-user/ftp-service /etc/cron.d/.\n",
                "sudo wget https://ftp-ec2-s3-cf.s3.us-west-2.amazonaws.com/move-to-s3.sh\n",
                "sudo chmod 755 move-to-s3.sh ftp.sh\n",
                "sudo chown -R ec2-user *\n",
                "sudo service crond restart\n",
                "sudo /home/ec2-user/ftp.sh\n"
                ]]}}
         }
      },
      "EC2SecurityGroup": {
         "Type": "AWS::EC2::SecurityGroup",
         "Properties": {
            "GroupDescription": "ftp server security group",
            "GroupName": "ftp-server-security-group",
            "VpcId": "vpc-f6785291",
            "SecurityGroupIngress": [
               {
                  "CidrIp": "0.0.0.0/0",
                  "FromPort": 1024,
                  "IpProtocol": "tcp",
                  "ToPort": 65535
               },
               {
                  "CidrIp": "0.0.0.0/0",
                  "Description": "",
                  "FromPort": 21,
                  "IpProtocol": "tcp",
                  "ToPort": 21
               },
               {
                  "CidrIp": "0.0.0.0/0",
                  "Description": "",
                  "FromPort": 22,
                  "IpProtocol": "tcp",
                  "ToPort": 22
               }
            ]  
         }
      },
      "EC2Volume": {
         "Type": "AWS::EC2::Volume",
         "Properties": {
            "AvailabilityZone": { "Fn::Select" : [ "2", { "Fn::GetAZs" : { "Ref" : "AWS::Region" } } ] },
            "Encrypted": false,
            "Size": 8,
            "VolumeType": "gp2",
            "MultiAttachEnabled": false
         }
      },
      "EC2VolumeAttachment": {
         "Type": "AWS::EC2::VolumeAttachment",
         "Properties": {
            "VolumeId": { "Ref" : "EC2Volume" },
            "InstanceId": { "Ref" : "EC2Instance" },
            "Device": "/dev/sdf"
         }
      }
   }
}